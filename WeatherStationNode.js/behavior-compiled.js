var state_js=require("./lib/state.js");function buildStateMachine(a){return new state_js.StateMachine(a)}function buildRegion(a,b){return new state_js.Region(a,b)}function buildInitialState(a,b){return new state_js.PseudoState(a,state_js.PseudoStateKind.Initial,b)}function buildFinalState(a,b){return new state_js.PseudoState(a,state_js.PseudoStateKind.Final,b)}function buildHistoryState(a,b){return new state_js.PseudoState(a,state_js.PseudoStateKind.ShallowHistory,b)}
function buildSimpleState(a,b){return new state_js.SimpleState(a,b)}function buildCompositeState(a,b){return new state_js.CompositeState(a,b)}function buildEmptyTransition(a,b){return new state_js.Transition(a,b)}function buildTransition(a,b,h){return new state_js.Transition(a,b,h)}function Connector(a,b,h,e){this.client=a;this.server=b;this.clientPort=h;this.serverPort=e}
Connector.prototype.forward=function(a){a=JSON.parse(a);a.port===this.clientPort?(a.port=this.serverPort,this.server._receive(JSON.stringify(a))):(a.port=this.clientPort,this.client._receive(JSON.stringify(a)))};
function MessageSerializer(a,b,h,e,k,g,m,c,f,q,l,d){function s(a){for(var d=0;2>d;d++){var f=a&255;n(f);a=(a-f)/256}}function r(){var a=[],d=q+l[f],c=0,b=0;a[b]=k;for(var b=b+1,t;c<d;){t=l[c];if(t===k||t===g||t===m)a[b]=m,b+=1;a[b]=t;b+=1;c+=1}a[b]=g;return a}function u(a,b){d=0;n(1);n(0);n(0);c=d;n(a);f=d;n(b);d=q=d}function n(a){d===e&&console.log("ERROR: BUFFER OVERFLOW: "+a+" has been ignored. Current index = "+d);d<e&&(l[d]=a,d+=1)}function v(a){a='{"message":"write_bytes","port":"out_c", "b":['+
a+"]}";JSON.parse(a);for(var d=p.length,c=0;c<d;c++)p[c].forward(a)}this.ready=!1;this.PacketManager_lengthInteger__var=a;this.PacketManager_lengthString__var=b;this.PacketManager_lengthUInt16__var=h;this.PacketManager_MAX_PACKET_SIZE__var=e;this.PacketManager_START_BYTE__var=k;this.PacketManager_STOP_BYTE__var=g;this.PacketManager_ESCAPE_BYTE__var=m;this.PacketManager_CODE_POSITION__var=c;this.PacketManager_LENGTH_POSITION__var=f;this.PacketManager_DATA_POSITION__var=q;this.PacketManager_buffer__var=
l;this.PacketManager_index__var=d;var p=[];this.getConnectors=function(){return p};var w=[];this.getQueue=function(){return w};this.serializeInteger=function(a){s(a)};this.serializeUInt16=function(a){s(a)};this.escape=function(){r()};this.send=function(){v(r())};this.setHeader=function(a,d){u(a,d)};this.storeByte=function(a){n(a)};this.readByte=function(){d<e&&(d+=1);d===e&&console.log("ERROR: BUFFER OVERFLOW: trying to read out of buffer boundaries")};this.MessageSerializer_SerializerBehavior=buildStateMachine("SerializerBehavior");
a=buildRegion("_default",this.MessageSerializer_SerializerBehavior);this._initial_MessageSerializer_SerializerBehavior=buildInitialState("_initial",a);a=buildSimpleState("Serialize",a);a.entry=[function(a,d){console.log("Coder ready indeed!")}];new buildEmptyTransition(this._initial_MessageSerializer_SerializerBehavior,a);buildTransition(a,null,function(a,d){var c=JSON.parse(d);return"RemoteControl_c"===c.port&&"changeDisplay"===c.message}).effect=[function(a,d){JSON.parse(d);console.log("Serializing changeDisplay message");
u(20,0);v(r())}]}MessageSerializer.prototype._stop=function(){};MessageSerializer.prototype._init=function(){console.log("Coder ready!");this.MessageSerializer_SerializerBehavior.initialise(this._initial_MessageSerializer_SerializerBehavior);for(var a=this.getQueue().shift();null!=a;)this.MessageSerializer_SerializerBehavior.process(this._initial_MessageSerializer_SerializerBehavior,a),a=this.getQueue().shift();this.ready=!0};
MessageSerializer.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.MessageSerializer_SerializerBehavior.process(this._initial_MessageSerializer_SerializerBehavior,a),a=this.getQueue().shift()};MessageSerializer.prototype.getName=function(){return"MessageSerializer"};
function WeatherStation(){function a(a){JSON.parse(a);for(var c=h.length,f=0;f<c;f++)h[f].forward(a)}function b(){a('{"message":"changeDisplay","port":"RemoteControlOut_s"}')}this.ready=!1;var h=[];this.getConnectors=function(){return h};var e=[];this.getQueue=function(){return e};var k=[];this.getGuiListeners=function(){return k};this.WeatherStation_SensorsDisplayImpl=buildStateMachine("SensorsDisplayImpl");var g=buildRegion("_default",this.WeatherStation_SensorsDisplayImpl);this._initial_WeatherStation_SensorsDisplayImpl=
buildInitialState("_initial",g);g=buildSimpleState("Process",g);g.entry=[function(b,c){a('{"message":"timer_start","port":"timer_c", "delay":3000}')}];new buildEmptyTransition(this._initial_WeatherStation_SensorsDisplayImpl,g);buildTransition(g,null,function(a,c){var f=JSON.parse(c);return"RemoteControlIn_s"===f.port&&"temperature"===f.message}).effect=[function(b,c){var f=JSON.parse(c);console.log("Temperature is: "+f.temp);f='{"message":"temperature","port":"gui_c", "temp":'+f.temp+"}";a(f);for(var g=
k.length,e=0;e<g;e++)k[e](f)}];buildTransition(g,null,function(a,c){var f=JSON.parse(c);return"RemoteControlIn_s"===f.port&&"light"===f.message}).effect=[function(b,c){var f=JSON.parse(c);console.log("Light is: "+f.light);f='{"message":"light","port":"gui_c", "light":'+f.light+"}";a(f);for(var g=k.length,e=0;e<g;e++)k[e](f)}];buildTransition(g,g,function(a,c){var f=JSON.parse(c);return"timer_c"===f.port&&"timer_timeout"===f.message}).effect=[function(a,c){JSON.parse(c);console.log("Changing Display on Arduino");
b()}];buildTransition(g,null,function(a,c){var f=JSON.parse(c);return"gui_c"===f.port&&"changeDisplay"===f.message}).effect=[function(a,c){JSON.parse(c);console.log("Changing Display on Arduino");b()}]}WeatherStation.prototype._stop=function(){};
WeatherStation.prototype._init=function(){console.log("Weather station ready!");this.WeatherStation_SensorsDisplayImpl.initialise(this._initial_WeatherStation_SensorsDisplayImpl);for(var a=this.getQueue().shift();null!=a;)this.WeatherStation_SensorsDisplayImpl.process(this._initial_WeatherStation_SensorsDisplayImpl,a),a=this.getQueue().shift();this.ready=!0};
WeatherStation.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.WeatherStation_SensorsDisplayImpl.process(this._initial_WeatherStation_SensorsDisplayImpl,a),a=this.getQueue().shift()};WeatherStation.prototype.getName=function(){return"WeatherStation"};WeatherStation.prototype.receivechangeDisplayOngui=function(){this._receive('{"message":"changeDisplay","port":"gui_c"}')};
function SerialJS(a,b,h,e,k){function g(a){if(19===e[0]&&18===a||18===e[0]){if(19!==a||125===e[k-1])e[k]=a,k+=1;if(19===a&&125!==e[k-1]){a='{"message":"receive_bytes","port":"read_s", "b":['+e+"]}";JSON.parse(a);for(var c=f.length,b=0;b<c;b++)f[b].forward(a);for(a=k=0;18>a;)e[a]=19,a+=1}}}function m(){for(var c=0;18>c;)e[c]=19,c+=1;h=new b.SerialPort(a,{baudrate:9600,parser:b.parsers.byteLength(1)},!1);h.open(function(a){if(a)console.log("ERROR: Problem opening the serial port... It might work, though most likely not :-)");
else h.on("data",function(a){g(a[0])});console.log("Serial port opened sucessfully!")})}function c(){h.close(function(a){a?console.log("ERROR: Problem closing the serial port..."):console.log("serial port closed!")})}this.ready=!1;this.SerialJS_serialPort__var=a;this.SerialJS_lib__var=b;this.SerialJS_serialP__var=h;this.SerialJS_buffer__var=e;this.SerialJS_index__var=k;var f=[];this.getConnectors=function(){return f};var q=[];this.getQueue=function(){return q};this.receive=function(a){g(a)};this.initSerial=
function(){m()};this.killSerial=function(){c()};this.SerialJS_behavior=buildStateMachine("behavior");var l=buildRegion("_default",this.SerialJS_behavior);this._initial_SerialJS_behavior=buildInitialState("_initial",l);l=buildSimpleState("default",l);new buildEmptyTransition(this._initial_SerialJS_behavior,l);buildTransition(l,null,function(a,c){var f=JSON.parse(c);return"write_s"===f.port&&"write_bytes"===f.message}).effect=[function(a,c){var f=JSON.parse(c);h.write(f.b,function(a,c){})}]}
SerialJS.prototype._stop=function(){this.killSerial();console.log("Serial port killed, RIP!")};SerialJS.prototype._init=function(){this.initSerial();console.log("Serial port ready!");this.SerialJS_behavior.initialise(this._initial_SerialJS_behavior);for(var a=this.getQueue().shift();null!=a;)this.SerialJS_behavior.process(this._initial_SerialJS_behavior,a),a=this.getQueue().shift();this.ready=!0};
SerialJS.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.SerialJS_behavior.process(this._initial_SerialJS_behavior,a),a=this.getQueue().shift()};SerialJS.prototype.getName=function(){return"SerialJS"};
function MessageDeserializer(a,b,h,e,k,g,m,c,f,q,l,d){function s(){d=q;var a=l[c];10===a&&r();11===a&&u()}function r(){var a=n();console.log("t: "+a);x('{"message":"temperature","port":"RemoteControl_c", "temp":'+a+"}")}function u(){var a=n();console.log("l: "+a);x('{"message":"light","port":"RemoteControl_c", "light":'+a+"}")}function n(){for(var a=0,c=1;0<=c;c--)a=256*a+w();return a}function v(a){d=0;var c=q+a[f+1]+1,b=0,e=a[b];if(e===k){var b=b+1,h=a[b];if(h!==g){for(var l=!0;l&&b<c;)e=h,b+=1,
h=a[b],e===m&&(e=h,b+=1,c+=1,h=a[b]),p(e),l=!(h===g&&e!==m);p(e);s()}}}function p(a){d===e&&console.log("ERROR: BUFFER OVERFLOW: "+a+" has been ignored. Current index = "+d);d<e&&(l[d]=a,d+=1)}function w(){var a;d<e&&(a=l[d],d+=1);d===e&&(console.log("ERROR: BUFFER OVERFLOW: trying to read out of buffer boundaries"),a=g);return a}function z(){var a=[],c=q+l[f],b=0,d=0;a[d]=k;for(var d=d+1,e;b<c;){e=l[b];if(e===k||e===g||e===m)a[d]=m,d+=1;a[d]=e;d+=1;b+=1}a[d]=g;return a}function x(a){JSON.parse(a);
for(var c=y.length,b=0;b<c;b++)y[b].forward(a)}this.ready=!1;this.PacketManager_lengthInteger__var=a;this.PacketManager_lengthString__var=b;this.PacketManager_lengthUInt16__var=h;this.PacketManager_MAX_PACKET_SIZE__var=e;this.PacketManager_START_BYTE__var=k;this.PacketManager_STOP_BYTE__var=g;this.PacketManager_ESCAPE_BYTE__var=m;this.PacketManager_CODE_POSITION__var=c;this.PacketManager_LENGTH_POSITION__var=f;this.PacketManager_DATA_POSITION__var=q;this.PacketManager_buffer__var=l;this.PacketManager_index__var=
d;var y=[];this.getConnectors=function(){return y};var A=[];this.getQueue=function(){return A};this.forward=function(){s()};this.deserializeRemote_temperature=function(){r()};this.deserializeRemote_light=function(){u()};this.deserializeInteger=function(){n()};this.deserializeUInt16=function(){n()};this.receive=function(a){v(a)};this.setHeader=function(a,b){d=0;p(1);p(0);p(0);c=d;p(a);f=d;p(b);d=q=d};this.storeByte=function(a){p(a)};this.readByte=function(){w()};this.escape=function(){z()};this.send=
function(){var a=z();x('{"message":"write_bytes","port":"out_c", "b":['+a+"]}")};this.MessageDeserializer_receive=buildStateMachine("receive");a=buildRegion("_default",this.MessageDeserializer_receive);this._initial_MessageDeserializer_receive=buildInitialState("_initial",a);a=buildSimpleState("Idle",a);a.entry=[function(a,c){console.log("Decoder ready indeed!")}];new buildEmptyTransition(this._initial_MessageDeserializer_receive,a);buildTransition(a,null,function(a,c){var b=JSON.parse(c);return"in_c"===
b.port&&"receive_bytes"===b.message}).effect=[function(a,c){var b=JSON.parse(c);console.log("byte[] received from serial. Will try to decode it!...");v(b.b)}]}MessageDeserializer.prototype._stop=function(){};
MessageDeserializer.prototype._init=function(){console.log("Decoder ready!");this.MessageDeserializer_receive.initialise(this._initial_MessageDeserializer_receive);for(var a=this.getQueue().shift();null!=a;)this.MessageDeserializer_receive.process(this._initial_MessageDeserializer_receive,a),a=this.getQueue().shift();this.ready=!0};
MessageDeserializer.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.MessageDeserializer_receive.process(this._initial_MessageDeserializer_receive,a),a=this.getQueue().shift()};MessageDeserializer.prototype.getName=function(){return"MessageDeserializer"};
function TimerJS(){function a(){clearTimeout(this.timer)}function b(a){console.log("timer.start");this.timer=setTimeout(h,a)}function h(){console.log("timer.onTimeout");JSON.parse('{"message":"timer_timeout","port":"timer_s"}');for(var a=e.length,c=0;c<a;c++)e[c].forward('{"message":"timer_timeout","port":"timer_s"}')}this.ready=!1;var e=[];this.getConnectors=function(){return e};var k=[];this.getQueue=function(){return k};this.cancel=function(){a()};this.start=function(a){b(a)};this.onTimeout=function(){h()};
this.TimerJS_SoftTimer=buildStateMachine("SoftTimer");var g=buildRegion("_default",this.TimerJS_SoftTimer);this._initial_TimerJS_SoftTimer=buildInitialState("_initial",g);g=buildSimpleState("default",g);g.entry=[function(a,c){console.log("debug timer on entry")}];new buildEmptyTransition(this._initial_TimerJS_SoftTimer,g);buildTransition(g,null,function(a,c){var b=JSON.parse(c);return"timer_s"===b.port&&"timer_cancel"===b.message}).effect=[function(b,c){JSON.parse(c);a()}];buildTransition(g,null,
function(a,c){var b=JSON.parse(c);return"timer_s"===b.port&&"timer_start"===b.message&&0<b.delay}).effect=[function(a,c){var f=JSON.parse(c);console.log("debug timer");b(f.delay)}]}TimerJS.prototype._stop=function(){};TimerJS.prototype._init=function(){this.TimerJS_SoftTimer.initialise(this._initial_TimerJS_SoftTimer);for(var a=this.getQueue().shift();null!=a;)this.TimerJS_SoftTimer.process(this._initial_TimerJS_SoftTimer,a),a=this.getQueue().shift();this.ready=!0};
TimerJS.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.TimerJS_SoftTimer.process(this._initial_TimerJS_SoftTimer,a),a=this.getQueue().shift()};TimerJS.prototype.getName=function(){return"TimerJS"};
var JSWeatherNode_app=new WeatherStation,JSWeatherNode_serializer_buffer_array=[],JSWeatherNode_serializer=new MessageSerializer(2,8,2,16,18,19,125,3,4,5,JSWeatherNode_serializer_buffer_array,0),JSWeatherNode_serial_buffer_array=[],JSWeatherNode_serial=new SerialJS("COM13",require("serialport"),null,JSWeatherNode_serial_buffer_array,0),JSWeatherNode_timer=new TimerJS,JSWeatherNode_deserializer_buffer_array=[],JSWeatherNode_deserializer=new MessageDeserializer(2,8,2,16,18,19,125,3,4,5,JSWeatherNode_deserializer_buffer_array,
0);JSWeatherNode_serializer.getConnectors().push(new Connector(JSWeatherNode_serial,JSWeatherNode_serializer,"write_s","out_c"));JSWeatherNode_serial.getConnectors().push(new Connector(JSWeatherNode_serializer,JSWeatherNode_serial,"out_c","write_s"));JSWeatherNode_serializer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_serializer,"RemoteControlOut_s","RemoteControl_c"));
JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_serializer,JSWeatherNode_app,"RemoteControl_c","RemoteControlOut_s"));JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_timer,JSWeatherNode_app,"timer_s","timer_c"));JSWeatherNode_timer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_timer,"timer_c","timer_s"));JSWeatherNode_deserializer.getConnectors().push(new Connector(JSWeatherNode_serial,JSWeatherNode_deserializer,"read_s","in_c"));
JSWeatherNode_serial.getConnectors().push(new Connector(JSWeatherNode_deserializer,JSWeatherNode_serial,"in_c","read_s"));JSWeatherNode_deserializer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_deserializer,"RemoteControlIn_s","RemoteControl_c"));JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_deserializer,JSWeatherNode_app,"RemoteControl_c","RemoteControlIn_s"));JSWeatherNode_app._init();JSWeatherNode_serializer._init();JSWeatherNode_timer._init();JSWeatherNode_deserializer._init();
JSWeatherNode_serial._init();process.on("SIGINT",function(){JSWeatherNode_app._stop();JSWeatherNode_serial._stop();JSWeatherNode_deserializer._stop();JSWeatherNode_serializer._stop();JSWeatherNode_timer._stop()});
function WebSocketGuiListener(a,b){var h=require("websocket").server,e=require("websocket").client,k=require("http").createServer(function(a,b){console.log(new Date+" Received request for "+a.url);b.writeHead(404);b.end()});k.listen(b,function(){console.log(new Date+" Server is listening on port "+b)});wsServer=new h({httpServer:k,autoAcceptConnections:!1});var g=[];wsServer.on("request",function(a){var b=a.accept(null,a.origin);g.push(b);console.log(new Date+" Connection accepted.");b.on("message",
function(a){if("utf8"===a.type){console.log("Received Message: "+a.utf8Data);for(var b=g.length,c=0;c<b;c++)g[c].sendUTF(a.utf8Data)}});b.on("close",function(a,c){console.log(new Date+" Peer "+b.remoteAddress+" disconnected.");var d=g.indexOf(b);-1<d&&g.splice(d,1)})});var h=new e,m=null;h.on("connectFailed",function(a){console.log("Connect Error: "+a.toString())});h.on("connect",function(b){m=b;console.log("WebSocket client connected");b.on("error",function(a){console.log("Connection Error: "+a.toString())});
b.on("close",function(){console.log("thingml-protocol Connection Closed");m=null});b.on("message",function(b){if("utf8"===b.type){var c=JSON.parse(b.utf8Data);"gui"===c.port.split("_")[0]&&"changeDisplay"===c.message&&a.receivechangeDisplayOngui();console.log("Received: '"+b.utf8Data+"'")}})});h.connect("ws://localhost:"+b+"/",null);this.onMessage=function(b){console.log(b);b=JSON.parse(b);b.thing=a.getName();b.port=b.port.split("_")[0];("gui"===b.port&&"light"===b.message||"temperature"===b.message)&&
m.sendUTF(JSON.stringify(b))};this._stop=function(){console.log("Stopping WebSocket...");m.close();wsServer.shutDown();k.close();console.log("Stopping WebSocket... done!")}}var wsGuiListener=new WebSocketGuiListener(JSWeatherNode_app,8080);JSWeatherNode_app.getGuiListeners().push(wsGuiListener.onMessage);process.on("SIGINT",function(){wsGuiListener._stop()});
